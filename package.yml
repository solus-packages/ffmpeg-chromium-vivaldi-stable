name       : ffmpeg-chromium-vivaldi-stable
version    : 104.0.5112.79
release    : 5
source     :
    - https://commondatastorage.googleapis.com/chromium-browser-official/chromium-104.0.5112.79.tar.xz : 9cc662f1a84c796521ee17ed2808795ca937fe7f77bc605e788f0304a81dabf3
license    :
    - BSD-3-Clause
    - LGPL-3.0-or-later
    - GPL-3.0-or-later
component  : multimedia.codecs
summary    : Chromium's ffmpeg for vivaldi-stable.
description: |
    Chromium's ffmpeg for vivaldi-stable with support for proprietary codecs such as H.264 enabled.
clang      : yes
libsplit   : no
optimize   : no-symbolic
builddeps  :
    - pkgconfig(dri)
    - pkgconfig(gtk+-x11-3.0)
    - pkgconfig(json-glib-1.0)
    - pkgconfig(krb5-gssapi)
    - pkgconfig(lcms2)
    - pkgconfig(libcurl)
    - pkgconfig(libdrm)
    - pkgconfig(libjpeg)
    - pkgconfig(libpci)
    - pkgconfig(libpulse)
    - pkgconfig(libva)
    - pkgconfig(libxslt)
    - pkgconfig(nss)
    - pkgconfig(xtst)
    - pkgconfig(xscrnsaver)
    - cups-devel
    - git
    - nodejs
environment: |
    unset LD_AS_NEEDED
setup      : |
    FLAGS=(`cat $pkgfiles/gn-build-config`)

    # Misc
    %patch -Np0 < $pkgfiles/unexpire-accelerated-video-decode-flag.patch
    %patch -p1 < $pkgfiles/0001-Unset-no-opaque-pointers.patch
    %patch -p1 < $pkgfiles/0001-Add-missing-include.patch

    # Bootstrap GN with build config
    python tools/gn/bootstrap/bootstrap.py --gn-gen-args "${FLAGS[*]}"

    # Fix missing tools
    mkdir -p third_party/node/linux/node-linux-x64/bin
    ln -s /usr/bin/node third_party/node/linux/node-linux-x64/bin/
build      : |
    ninja -C out/Release media/ffmpeg -v
install    : |
    install -Dm00644 out/Release/libffmpeg.so $installdir/usr/share/vivaldi-stable/libffmpeg.so
